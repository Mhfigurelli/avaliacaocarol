<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enviar pedido de avalia√ß√£o</title>
  <style>
    :root { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#f7fafc; color:#111827; }
    .wrap { min-height:100svh; padding:24px; }
    .container { max-width:1200px; margin:0 auto; }
    .header { text-align:center; margin-bottom:32px; }
    .header h1 { font-size:28px; font-weight:700; margin:0 0 8px; }
    .header p { color:#6b7280; margin:0; }
    
    .grid { display:grid; gap:20px; grid-template-columns:1fr; }
    @media(min-width:768px) { .grid { grid-template-columns:1fr 1fr; } }
    
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 10px 20px rgba(0,0,0,.05); overflow:hidden; }
    .card .hd { padding:20px 24px; border-bottom:1px solid #f3f4f6; }
    .card .hd h2 { font-size:18px; font-weight:600; margin:0 0 4px; display:flex; align-items:center; gap:8px; }
    .card .hd .subtitle { font-size:13px; color:#6b7280; margin:0; }
    .card .bd { padding:24px; }
    
    .icon { width:20px; height:20px; }
    
    label { font-size:14px; font-weight:600; margin-bottom:6px; display:block; }
    input, select { width:100%; padding:12px 14px; border:1px solid #e5e7eb; border-radius:10px; font-size:16px; box-sizing:border-box; }
    input:focus, select:focus { outline:none; border-color:#6366f1; box-shadow:0 0 0 3px rgba(99,102,241,.2); }
    
    .file-input-wrapper { position:relative; }
    .file-input-wrapper input[type="file"] { 
      position:absolute; width:1px; height:1px; opacity:0; overflow:hidden; 
    }
    .file-input-label { 
      display:flex; align-items:center; justify-content:center; gap:8px;
      padding:12px 14px; border:2px dashed #d1d5db; border-radius:10px; 
      cursor:pointer; transition:all .2s; background:#fafafa;
    }
    .file-input-label:hover { border-color:#6366f1; background:#f5f5ff; }
    .file-input-label.has-file { border-color:#10b981; background:#ecfdf5; }
    
    .row { display:grid; gap:10px; margin-bottom:16px; }
    .hint { font-size:12px; color:#6b7280; }
    .error { color:#b91c1c; font-size:12px; margin-top:6px; }
    
    .btn { 
      width:100%; height:44px; border:0; border-radius:12px; 
      background:#111827; color:#fff; font-size:16px; font-weight:600; 
      cursor:pointer; transition:all .2s;
    }
    .btn:hover:not(:disabled) { background:#1f2937; transform:translateY(-1px); }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn.secondary { background:#6366f1; }
    .btn.secondary:hover:not(:disabled) { background:#4f46e5; }
    .btn.success { background:#10b981; }
    .btn.success:hover:not(:disabled) { background:#059669; }
    .btn.danger { background:#ef4444; }
    .btn.danger:hover:not(:disabled) { background:#dc2626; }
    
    .alert { margin-top:16px; padding:12px 14px; border-radius:12px; font-size:14px; display:none; }
    .ok   { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .fail { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
    .info { background:#eff6ff; color:#1e40af; border:1px solid #bfdbfe; }
    
    .badge { background:#f3f4f6; border:1px solid #e5e7eb; padding:6px 8px; border-radius:10px; font-size:12px; display:inline-block; }
    
    .stats { display:grid; grid-template-columns:repeat(auto-fit, minmax(100px, 1fr)); gap:12px; margin-top:16px; }
    .stat-box { background:#f9fafb; padding:12px; border-radius:10px; text-align:center; }
    .stat-box .number { font-size:24px; font-weight:700; color:#111827; }
    .stat-box .label { font-size:12px; color:#6b7280; margin-top:4px; }
    
    .file-name { font-size:13px; color:#374151; margin-top:8px; font-weight:500; }
    
    /* Preview Table */
    .preview-section { margin-top:20px; display:none; }
    .preview-header { 
      display:flex; justify-content:space-between; align-items:center; 
      padding:12px; background:#f9fafb; border-radius:8px; margin-bottom:12px;
    }
    .preview-header h3 { margin:0; font-size:16px; font-weight:600; }
    .preview-count { font-size:14px; color:#6b7280; }
    
    .table-wrapper { 
      max-height:400px; overflow-y:auto; border:1px solid #e5e7eb; 
      border-radius:8px; margin-bottom:16px;
    }
    table { width:100%; border-collapse:collapse; }
    thead { position:sticky; top:0; background:#f9fafb; z-index:1; }
    th { 
      padding:12px; text-align:left; font-size:13px; font-weight:600; 
      border-bottom:2px solid #e5e7eb; color:#374151;
    }
    td { padding:12px; font-size:14px; border-bottom:1px solid #f3f4f6; }
    tbody tr:hover { background:#f9fafb; }
    tbody tr:last-child td { border-bottom:none; }
    
    .btn-group { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    
    /* Modal */
    .modal { 
      display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
      background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;
    }
    .modal.show { display:flex; }
    .modal-content { 
      background:#fff; border-radius:16px; padding:24px; max-width:500px; 
      width:90%; margin:20px; box-shadow:0 20px 40px rgba(0,0,0,0.2);
    }
    .modal-header { margin-bottom:16px; }
    .modal-header h3 { margin:0; font-size:20px; font-weight:700; }
    .modal-body { margin-bottom:20px; color:#374151; line-height:1.6; }
    .modal-footer { display:flex; gap:12px; }
    .modal-footer .btn { width:auto; flex:1; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="container">
      <div class="header">
        <h1>üì± Sistema de Avalia√ß√µes WhatsApp</h1>
        <p>Envie pedidos de avalia√ß√£o individualmente ou em lote</p>
      </div>

      <div class="grid">
        <!-- Upload em Lote -->
        <div class="card">
          <div class="hd">
            <h2>
              <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
              Upload em Lote
            </h2>
            <p class="subtitle">Envie uma planilha Excel com m√∫ltiplos pacientes</p>
          </div>
          <div class="bd">
            <form id="batchForm">
              <div class="row">
                <label>Arquivo Excel</label>
                <div class="file-input-wrapper">
                  <input type="file" id="excelFile" accept=".xlsx,.xls">
                  <label for="excelFile" class="file-input-label" id="fileLabel">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    <span id="fileLabelText">Selecionar arquivo</span>
                  </label>
                  <div class="file-name" id="fileName" style="display:none;"></div>
                </div>
                <div class="hint">
                  Formato: colunas <strong>telefone</strong> e <strong>nome</strong><br>
                  Exemplo: <code>11999998888</code> | <code>Jo√£o Silva</code>
                </div>
              </div>

              <div class="row">
                <label for="batchDelay">Delay para envio (minutos)</label>
                <input type="number" id="batchDelay" value="10" min="0" max="1440">
                <div class="hint">Tempo de espera antes do envio come√ßar</div>
              </div>

              <button type="button" class="btn secondary" id="previewBtn" disabled>
                üëÅÔ∏è Visualizar Dados
              </button>

              <div id="batchAlert" class="alert"></div>
              
              <!-- Preview Section -->
              <div id="previewSection" class="preview-section">
                <div class="preview-header">
                  <h3>üìã Pr√©via dos Envios</h3>
                  <span class="preview-count" id="previewCount">0 contatos</span>
                </div>
                
                <div class="table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>Nome</th>
                        <th>Telefone</th>
                      </tr>
                    </thead>
                    <tbody id="previewTableBody">
                    </tbody>
                  </table>
                </div>

                <div class="btn-group">
                  <button type="button" class="btn danger" id="cancelBtn">
                    ‚ùå Cancelar
                  </button>
                  <button type="submit" class="btn success" id="confirmBtn">
                    ‚úÖ Confirmar Envio
                  </button>
                </div>
              </div>
              
              <div id="batchStats" style="display:none;">
                <div class="stats">
                  <div class="stat-box">
                    <div class="number" id="statTotal">0</div>
                    <div class="label">Total</div>
                  </div>
                  <div class="stat-box">
                    <div class="number" id="statInserted" style="color:#10b981;">0</div>
                    <div class="label">Agendados</div>
                  </div>
                  <div class="stat-box">
                    <div class="number" id="statErrors" style="color:#ef4444;">0</div>
                    <div class="label">Erros</div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- Envio Individual -->
        <div class="card">
          <div class="hd">
            <h2>
              <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
              </svg>
              Envio Individual
            </h2>
            <p class="subtitle">Envie para um paciente espec√≠fico</p>
          </div>
          <div class="bd">
            <form id="singleForm">
              <div class="row">
                <label for="name">Nome do paciente</label>
                <input id="name" placeholder="Ex.: Maria Souza" />
                <div id="nameErr" class="error" style="display:none"></div>
              </div>

              <div class="row">
                <label for="phone">Telefone (Brasil)</label>
                <input id="phone" placeholder="DDD 9XXXX-XXXX" inputmode="numeric" />
                <div class="hint">Formato enviado: <span id="e164" class="badge">+55XXXXXXXXXX</span></div>
                <div id="phoneErr" class="error" style="display:none"></div>
              </div>

              <div class="row">
                <label for="delay">Delay para envio (minutos)</label>
                <input type="number" id="delay" value="10" min="0" max="1440">
                <div class="hint">Tempo de espera antes do envio</div>
              </div>

              <button type="submit" class="btn" id="submitBtn" disabled>
                üì® Enviar
              </button>

              <div id="singleAlert" class="alert"></div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Erro -->
  <div id="errorModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚ö†Ô∏è Erros Encontrados</h3>
      </div>
      <div class="modal-body" id="errorModalBody">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" onclick="closeErrorModal()">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    // ============ ENVIO INDIVIDUAL ============
    const singleForm = document.getElementById('singleForm');
    const nameEl = document.getElementById('name');
    const phoneEl = document.getElementById('phone');
    const delayEl = document.getElementById('delay');
    const e164El = document.getElementById('e164');
    const submitBtn = document.getElementById('submitBtn');
    const singleAlert = document.getElementById('singleAlert');
    const nameErr = document.getElementById('nameErr');
    const phoneErr = document.getElementById('phoneErr');

    function toE164BR(v){
      const d = v.replace(/\D/g,'').replace(/^0+/, '');
      if(!d) return '';
      return '+55' + d;
    }

    function maskBR(v){
      const d = v.replace(/\D/g, '').slice(0, 11);
      const ddd = d.slice(0, 2);
      const rest = d.slice(2);
      if (!rest) return ddd;
      if (rest.length <= 4) return `${ddd} ${rest}`;
      if (rest.length <= 8) return `${ddd} ${rest.slice(0,4)}-${rest.slice(4)}`;
      return `${ddd} ${rest.slice(0,5)}-${rest.slice(5)}`;
    }

    function validateSingle(){
      const name = nameEl.value.trim();
      const raw = phoneEl.value;
      const digits = raw.replace(/\D/g,'');
      let ok = true;
      
      nameErr.style.display = 'none';
      phoneErr.style.display = 'none';
      
      if(name.length < 2){ 
        nameErr.textContent = 'Informe o nome.'; 
        nameErr.style.display = 'block'; 
        ok = false; 
      }
      
      if(digits.length < 10 || digits.length > 11){ 
        phoneErr.textContent = 'Use DDD + n√∫mero (10 ou 11 d√≠gitos).'; 
        phoneErr.style.display = 'block'; 
        ok = false; 
      }
      
      e164El.textContent = toE164BR(raw) || '+55XXXXXXXXXX';
      submitBtn.disabled = !ok;
    }

    phoneEl.addEventListener('input', (e) => { 
      e.target.value = maskBR(e.target.value); 
      validateSingle(); 
    });
    nameEl.addEventListener('input', validateSingle);
    validateSingle();

    singleForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      submitBtn.disabled = true;
      singleAlert.style.display = 'none';
      
      const to = toE164BR(phoneEl.value);
      const name = nameEl.value.trim();
      const delayMinutes = parseInt(delayEl.value) || 10;
      
      try {
        const r = await fetch('/api/send-one', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ to, name, delayMinutes })
        });
        const data = await r.json();
        
        if(!r.ok) throw new Error(data?.error || 'Falha ao enviar');
        
        singleAlert.className = 'alert ok';
        singleAlert.innerHTML = `
          ‚úÖ <strong>Agendado com sucesso!</strong><br>
          <small>Envio em: ${new Date(data.scheduled_for).toLocaleString('pt-BR')}</small>
        `;
        singleAlert.style.display = 'block';
        singleForm.reset();
        validateSingle();
      } catch(err) {
        singleAlert.className = 'alert fail';
        singleAlert.textContent = '‚ùå ' + (err.message || 'Erro ao enviar');
        singleAlert.style.display = 'block';
        submitBtn.disabled = false;
      }
    });

    // ============ UPLOAD EM LOTE ============
    const batchForm = document.getElementById('batchForm');
    const excelFile = document.getElementById('excelFile');
    const fileLabel = document.getElementById('fileLabel');
    const fileLabelText = document.getElementById('fileLabelText');
    const fileName = document.getElementById('fileName');
    const batchDelay = document.getElementById('batchDelay');
    const previewBtn = document.getElementById('previewBtn');
    const confirmBtn = document.getElementById('confirmBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const batchAlert = document.getElementById('batchAlert');
    const batchStats = document.getElementById('batchStats');
    const previewSection = document.getElementById('previewSection');
    const previewTableBody = document.getElementById('previewTableBody');
    const previewCount = document.getElementById('previewCount');

    let previewData = null;

    excelFile.addEventListener('change', (e) => {
      previewSection.style.display = 'none';
      batchAlert.style.display = 'none';
      previewData = null;
      
      if(e.target.files.length > 0) {
        const file = e.target.files[0];
        fileLabel.classList.add('has-file');
        fileLabelText.textContent = '‚úì Arquivo selecionado';
        fileName.textContent = file.name;
        fileName.style.display = 'block';
        previewBtn.disabled = false;
      } else {
        fileLabel.classList.remove('has-file');
        fileLabelText.textContent = 'Selecionar arquivo';
        fileName.style.display = 'none';
        previewBtn.disabled = true;
      }
    });

    // Ler e mostrar preview do Excel
    previewBtn.addEventListener('click', async () => {
      if(!excelFile.files[0]) {
        alert('Selecione um arquivo Excel');
        return;
      }

      previewBtn.disabled = true;
      batchAlert.style.display = 'none';
      
      batchAlert.className = 'alert info';
      batchAlert.textContent = '‚è≥ Lendo arquivo...';
      batchAlert.style.display = 'block';

      try {
        // Ler o arquivo localmente usando SheetJS
        const file = excelFile.files[0];
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        if(!jsonData || jsonData.length === 0) {
          throw new Error('Planilha vazia ou formato inv√°lido');
        }

        // Processar e validar dados
        const validContacts = [];
        const errors = [];

        jsonData.forEach((row, i) => {
          const phone = row.telefone || row.to || row.numero || row.phone || 
                        row.Telefone || row.TO || row.Numero || row.Phone;
          const name = row.nome || row.name || row.paciente || 
                       row.Name || row.Nome || row.Paciente;
          
          if(!phone || !name) {
            errors.push({ linha: i + 2, motivo: 'Telefone ou nome ausente' });
          } else {
            validContacts.push({ phone: String(phone), name: String(name) });
          }
        });

        if(validContacts.length === 0) {
          throw new Error('Nenhum contato v√°lido encontrado na planilha');
        }

        // Salvar dados para envio posterior
        previewData = validContacts;

        // Montar tabela de preview
        previewTableBody.innerHTML = validContacts.map((contact, i) => `
          <tr>
            <td>${i + 1}</td>
            <td>${contact.name}</td>
            <td>${toE164BR(contact.phone)}</td>
          </tr>
        `).join('');

        previewCount.textContent = `${validContacts.length} contato${validContacts.length !== 1 ? 's' : ''}`;
        previewSection.style.display = 'block';
        
        batchAlert.className = 'alert ok';
        batchAlert.innerHTML = `
          ‚úÖ <strong>Arquivo lido com sucesso!</strong><br>
          <small>${validContacts.length} contato(s) v√°lido(s) encontrado(s)</small>
          ${errors.length > 0 ? `<br><small style="color:#dc2626;">‚ö†Ô∏è ${errors.length} linha(s) com erro - <a href="#" onclick="showErrors(event)" style="text-decoration:underline;">ver detalhes</a></small>` : ''}
        `;
        batchAlert.style.display = 'block';

        // Guardar erros para mostrar depois
        window.previewErrors = errors;
        
      } catch(err) {
        batchAlert.className = 'alert fail';
        batchAlert.textContent = '‚ùå ' + (err.message || 'Erro ao ler arquivo');
        batchAlert.style.display = 'block';
        previewBtn.disabled = false;
      }
    });

    // Cancelar preview
    cancelBtn.addEventListener('click', () => {
      previewSection.style.display = 'none';
      previewData = null;
      batchAlert.style.display = 'none';
      previewBtn.disabled = false;
    });

    // Confirmar e enviar
    batchForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      
      if(!previewData || previewData.length === 0) {
        alert('Nenhum dado para enviar. Clique em "Visualizar Dados" primeiro.');
        return;
      }

      confirmBtn.disabled = true;
      cancelBtn.disabled = true;
      batchAlert.style.display = 'none';
      batchStats.style.display = 'none';
      
      batchAlert.className = 'alert info';
      batchAlert.textContent = '‚è≥ Processando e agendando envios...';
      batchAlert.style.display = 'block';

      const formData = new FormData();
      formData.append('file', excelFile.files[0]);
      formData.append('delayMinutes', batchDelay.value);

      try {
        const r = await fetch('/api/upload-excel', {
          method: 'POST',
          body: formData
        });
        const data = await r.json();
        
        if(!r.ok) throw new Error(data?.error || 'Falha ao processar');
        
        // Mostrar estat√≠sticas
        document.getElementById('statTotal').textContent = data.total_rows;
        document.getElementById('statInserted').textContent = data.inserted;
        document.getElementById('statErrors').textContent = data.errors;
        batchStats.style.display = 'block';
        
        batchAlert.className = 'alert ok';
        batchAlert.innerHTML = `
          ‚úÖ <strong>Envios agendados com sucesso!</strong><br>
          <small>Lote: ${data.batch_id}</small><br>
          <small>Envio programado para: ${new Date(data.scheduled_for).toLocaleString('pt-BR')}</small>
          ${data.errors > 0 ? `<br><small style="color:#dc2626;">‚ö†Ô∏è ${data.errors} linha(s) com erro</small>` : ''}
        `;
        batchAlert.style.display = 'block';
        
        // Reset form
        previewSection.style.display = 'none';
        previewData = null;
        batchForm.reset();
        fileLabel.classList.remove('has-file');
        fileLabelText.textContent = 'Selecionar arquivo';
        fileName.style.display = 'none';
        previewBtn.disabled = true;
        
      } catch(err) {
        batchAlert.className = 'alert fail';
        batchAlert.textContent = '‚ùå ' + (err.message || 'Erro ao processar');
        batchAlert.style.display = 'block';
        confirmBtn.disabled = false;
        cancelBtn.disabled = false;
      }
    });

    // Modal de erros
    function showErrors(e) {
      e.preventDefault();
      const errors = window.previewErrors || [];
      if(errors.length === 0) return;
      
      const modal = document.getElementById('errorModal');
      const body = document.getElementById('errorModalBody');
      
      body.innerHTML = `
        <p><strong>${errors.length} linha(s) com problema:</strong></p>
        <ul style="margin:8px 0; padding-left:20px;">
          ${errors.map(err => `<li>Linha ${err.linha}: ${err.motivo}</li>`).join('')}
        </ul>
        <p style="font-size:13px; color:#6b7280; margin-top:12px;">
          Apenas os contatos v√°lidos ser√£o enviados.
        </p>
      `;
      
      modal.classList.add('show');
    }

    function closeErrorModal() {
      document.getElementById('errorModal').classList.remove('show');
    }

    // Carregar SheetJS via CDN
    const script = document.createElement('script');
    script.src = 'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';
    document.head.appendChild(script);
  </script>
</body>
</html>
